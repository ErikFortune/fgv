# Coverage Gap Analysis - ts-sudoku-lib

**Generated:** 2025-10-19
**Overall Coverage:** 97.27% statements, 94.53% branches, 97.4% functions, 97.27% lines

## Summary

Current coverage status against thresholds:
- ✅ Statements: 97.27% (threshold: 95%)
- ❌ Branches: 94.53% (threshold: 95%) - **0.47% gap**
- ❌ Functions: 97.4% (threshold: 100%) - **2.6% gap**
- ✅ Lines: 97.27% (threshold: 95%)

**Critical Finding:** The functions threshold of 100% is not met. This is the primary blocker for full coverage compliance.

---

## Gap Categories

### 1. Infrastructure/Type Definitions (0% coverage - IGNORE)

These files contain only type definitions, interfaces, or re-exports with no executable code requiring tests.

#### killerCombinationsTypes.ts (0% coverage)
- **Lines:** 1-41
- **Category:** Type definitions only
- **Action:** Add c8 ignore directive to entire file
- **Justification:** File contains only TypeScript interfaces (`IKillerConstraints`) with no executable code

---

### 2. Functional Tests Needed (Business Logic)

These gaps represent actual business logic that should be tested.

#### puzzleDefinitions.ts (82.1% statements, 90.9% functions)

**Lines 73-76** - Validation error path for killer sudoku
```typescript
if (cells.length < expectedBasicLength) {
  return fail(`Killer sudoku cells must contain at least ${expectedBasicLength} grid cells, got ${cells.length}`);
}
```
- **Priority:** HIGH
- **Category:** Validation logic
- **Action:** Add test for killer sudoku with too few cells
- **Test needed:**
  ```typescript
  test('should fail when killer sudoku cells are too short', () => {
    const shortCells = 'A.B.C|'; // Deliberately too short
    expect(PuzzleDefinitions.validateKillerCells(shortCells, dimensions))
      .toFailWith(/must contain at least/i);
  });
  ```

**Lines 104-105** - Invalid character validation
```typescript
if (!validDigits.has(char) && !validCageLetters.has(char)) {
  return fail(`Invalid character '${char}' at position ${i} in killer sudoku grid portion`);
}
```
- **Priority:** HIGH
- **Category:** Validation logic
- **Action:** Add test with invalid character in killer sudoku grid
- **Test needed:**
  ```typescript
  test('should reject invalid character in killer sudoku grid', () => {
    const invalidCells = 'A.B@C.D.E|cagedata'; // @ is invalid
    expect(validator.validateCells(invalidCells, dimensions))
      .toFailWith(/invalid character/i);
  });
  ```

**Lines 217-218** - Unknown puzzle type validation
```typescript
if (!validator) {
  return fail(`Unknown puzzle type: ${puzzleType}`);
}
```
- **Priority:** HIGH
- **Category:** Validation logic
- **Action:** Add test for unknown puzzle type
- **Test needed:**
  ```typescript
  test('should fail for unknown puzzle type', () => {
    expect(PuzzleDefinitions.create(dimensions, {
      cells: validCells,
      type: 'invalid-type' as any
    })).toFailWith(/unknown puzzle type/i);
  });
  ```

**Lines 256-309** - createKiller method (ENTIRE FUNCTION UNCOVERED)
- **Priority:** HIGH
- **Category:** Business logic - complete feature
- **Action:** Add comprehensive tests for createKiller factory method
- **Test needed:** Multiple tests covering:
  1. Successful killer puzzle creation
  2. Invalid killer cage data
  3. Dimension validation
  4. Cage conversion logic

**Lines 326-327** - Board dimension validation
```typescript
if (dimensions.boardWidthInCages < 1 || dimensions.boardHeightInCages < 1) {
  return fail('Board dimensions must be positive integers');
}
```
- **Priority:** HIGH
- **Category:** Validation logic
- **Action:** Add test with non-positive board dimensions

**Lines 334-335** - Grid size limits
```typescript
if (totalRows > 25 || totalColumns > 25) {
  return fail('Total grid size must not exceed 25x25');
}
```
- **Priority:** HIGH
- **Category:** Validation logic
- **Action:** Add test attempting to create 26x26 grid

**Lines 340-341** - Cage size validation
```typescript
if (maxValue < 2 || maxValue > 25) {
  return fail('Cage size must result in values between 2 and 25');
}
```
- **Priority:** HIGH
- **Category:** Validation logic
- **Action:** Add test with cage size resulting in maxValue = 1 or 26

#### collections.ts (95.95% statements, 74.19% branches)

**Lines 141-148** - Fallback configuration for odd-sized grids
```typescript
} else {
  // Fall back to single row/column cages for odd sizes
  config = {
    cageWidthInCells: size,
    cageHeightInCells: 1,
    boardWidthInCages: 1,
    boardHeightInCages: size
  };
}
```
- **Priority:** MEDIUM
- **Category:** Business logic - edge case handling
- **Action:** Add test for odd-sized grid (e.g., 5x5, 7x7)
- **Test needed:**
  ```typescript
  test('should create configuration for odd-sized square grid', () => {
    const config = DimensionConfigProvider.getConfigForSize(5, 5);
    expect(config).toSucceedAndSatisfy((cfg) => {
      expect(cfg.cageWidthInCells).toBe(5);
      expect(cfg.cageHeightInCells).toBe(1);
    });
  });
  ```

#### common.ts (98.63% statements)

**Lines 105-106** - Defensive guard for invalid cage size
```typescript
if (cageSize <= 0) {
  return { min: 0, max: 0 };
}
```
- **Priority:** LOW
- **Category:** Defensive coding
- **Action:** Add c8 ignore directive
- **Justification:** Defensive guard for invalid input that should never occur in normal usage

#### converters.ts (97.87% statements)

**Lines 64-65** - Cell ID format conflict detection
```typescript
if (from[0] === 'S' && from.length > 2 && /^[A-Z]/.test(from[1])) {
  return fail(`malformed cell ID "${from}" (conflicts with section cage ID format)`);
}
```
- **Priority:** MEDIUM
- **Category:** Validation logic
- **Action:** Add test for cell ID that conflicts with section cage format
- **Test needed:**
  ```typescript
  test('should reject cell ID conflicting with section cage format', () => {
    expect(Converters.cellId.convert('SAA00'))
      .toFailWith(/conflicts with section cage ID format/i);
  });
  ```

#### ids.ts (97.77% statements)

**Lines 49, 65, 81, 96** - Various ID conversion edge cases
- **Priority:** MEDIUM
- **Category:** Business logic - specific format handling
- **Action:** Add tests for large grid IDs requiring double-letter notation

#### puzzle.ts (98.61% statements)

**Lines 109-114** - Puzzle creation failure path
**Lines 271-272** - Additional edge case handling
- **Priority:** MEDIUM
- **Category:** Error handling
- **Action:** Add tests for puzzle creation failures

#### puzzles/internal/combinationCache.ts (92.68% statements, 60% functions)

**Lines 61-62** - Cache retrieval with cloning
**Lines 73-74** - Cache clearing when full
**Lines 80-81** - Size getter
- **Priority:** HIGH (for function coverage)
- **Category:** Business logic - cache management
- **Action:** Add tests for:
  1. Cache LRU behavior when hitting max size
  2. Deep cloning to prevent mutation
  3. Clear and size methods

**Missing Functions:**
- `clear()` - 0% coverage
- `size()` - 0% coverage

---

### 3. Files/Filesystem Integration (LOW coverage)

#### filesystem.ts (92.5% statements, 0% functions)

**Lines 38-40** - File loading function
```typescript
export function loadJsonPuzzlesFileSync(path: string): Result<IPuzzlesFile> {
  return JsonFile.convertJsonFileSync(path, puzzlesFile);
}
```
- **Priority:** LOW
- **Category:** Integration/Infrastructure
- **Action:** Consider adding integration test or c8 ignore
- **Justification:** File I/O function that may be tested in integration tests or example code

---

### 4. Intermittent Coverage Issues

These lines are functionally tested but coverage is intermittently missed in full test suite runs.

#### ids.ts (Lines 60-65) - Already has c8 ignore directive
```typescript
/* c8 ignore next 4 - functional code tested but coverage intermittently missed */
if (maxRow !== undefined) {
  const maxRowNum = maxRow + 1;
  const width = maxRowNum.toString().length;
  return rowNum.toString().padStart(width, '0');
}
```
- **Status:** Already properly handled with c8 ignore directive
- **Action:** None needed

#### Other candidates for intermittent coverage investigation:
- **puzzleSession.ts lines 82-83**
- **puzzleState.ts lines 104-105**
- **hints/explanations.ts lines 300-303**
- **hints/hiddenSingles.ts lines 295-297, 301**
- **hints/hints.ts lines 118-119, 181-182**
- **hints/nakedSingles.ts lines 186-187**

**Recommended Action:** Test each file individually to confirm if coverage is intermittent:
```bash
rushx test --test-path-pattern=puzzleSession.test
rushx test --test-path-pattern=puzzleState.test
# etc.
```

If individual tests show 100% coverage but full suite shows gaps, add c8 ignore directives.

---

## Priority Action Plan

### Immediate (Required for 100% Function Coverage)

1. **combinationCache.ts** - Test `clear()` and `size()` methods
   - These untested functions are causing the function coverage to miss 100% threshold
   - Simple tests to add

2. **puzzleDefinitions.ts** - Test `createKiller()` method
   - Large untested function (lines 256-309)
   - Critical for function coverage

### High Priority (Business Logic Gaps)

3. **puzzleDefinitions.ts** - Add validation tests for:
   - Short killer sudoku cells (lines 73-76)
   - Invalid characters (lines 104-105)
   - Unknown puzzle type (lines 217-218)
   - Board dimension validation (lines 326-327)
   - Grid size limits (lines 334-335)
   - Cage size validation (lines 340-341)

4. **collections.ts** - Test odd-sized grid fallback (lines 141-148)

5. **converters.ts** - Test cell ID format conflicts (lines 64-65)

### Medium Priority (Incremental Improvements)

6. **ids.ts** - Test large grid ID edge cases
7. **puzzle.ts** - Test creation failure paths
8. **Investigate intermittent coverage** for hint-related files

### Low Priority (Defensive/Integration)

9. **common.ts** - Add c8 ignore for defensive guard (lines 105-106)
10. **filesystem.ts** - Add integration test or c8 ignore
11. **killerCombinationsTypes.ts** - Add file-level c8 ignore

---

## Function Coverage Gap Detail

Currently at 97.4% functions (threshold: 100%)

**Untested Functions:**
1. `CombinationCache.clear()` - puzzles/internal/combinationCache.ts
2. `CombinationCache.size()` - puzzles/internal/combinationCache.ts
3. `PuzzleDefinitions.createKiller()` - common/puzzleDefinitions.ts
4. `loadJsonPuzzlesFileSync()` - files/filesystem.ts

**To reach 100% function coverage:** Test the above 4 functions.

---

## Recommended Next Steps

1. ✅ **Phase 1:** Add tests for `CombinationCache.clear()` and `.size()` methods
2. ✅ **Phase 2:** Add comprehensive tests for `PuzzleDefinitions.createKiller()`
3. ✅ **Phase 3:** Add validation tests for puzzleDefinitions.ts gaps
4. ✅ **Phase 4:** Test collections.ts odd-sized grid fallback
5. 🔍 **Phase 5:** Investigate and handle intermittent coverage issues
6. 🧹 **Phase 6:** Add c8 ignore directives for defensive code and type files

**Estimated effort:** 2-3 hours of focused test writing to reach 100% function coverage and 95%+ branch coverage.

---

## Files by Coverage Priority

### Critical (Blocking 100% function threshold)
- `puzzles/internal/combinationCache.ts` - Missing function tests
- `common/puzzleDefinitions.ts` - Missing createKiller() tests

### High (Business logic gaps)
- `common/puzzleDefinitions.ts` - Multiple validation gaps
- `collections/collections.ts` - Odd-size grid fallback
- `common/converters.ts` - Cell ID validation

### Medium (Edge cases and error paths)
- `common/ids.ts` - Large grid edge cases
- `common/puzzle.ts` - Error handling paths

### Low (Infrastructure/Defensive)
- `puzzles/killerCombinationsTypes.ts` - Type definitions only
- `files/filesystem.ts` - Integration function
- `common/common.ts` - Defensive guards

### Investigation Needed (Potential intermittent coverage)
- `hints/puzzleSessionHints.ts`
- `hints/nakedSingles.ts`
- `hints/hiddenSingles.ts`
- `hints/hints.ts`
- `common/puzzleSession.ts`
- `common/puzzleState.ts`
